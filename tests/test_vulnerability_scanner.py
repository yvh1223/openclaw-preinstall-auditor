import json
import tempfile
import unittest
from pathlib import Path

from src.scanners.vulnerability_scanner import VulnerabilityScanner


class VulnerabilityScannerNodeVersionTests(unittest.TestCase):
    def test_node_requirement_matching(self):
        scanner = VulnerabilityScanner(".")
        self.assertFalse(scanner._node_requirement_allows_vulnerable(">=22.12.0"))
        self.assertTrue(scanner._node_requirement_allows_vulnerable(">=22.10.0"))
        self.assertFalse(scanner._node_requirement_allows_vulnerable("^22.12.0"))
        self.assertTrue(scanner._node_requirement_allows_vulnerable("22.x"))
        self.assertFalse(scanner._node_requirement_allows_vulnerable(">=23"))

    def test_cve_2025_59466_finding_respects_node_engine(self):
        with tempfile.TemporaryDirectory() as tmp:
            repo = Path(tmp)

            vulnerable_pkg = {"engines": {"node": ">=22.10.0"}}
            (repo / "package.json").write_text(json.dumps(vulnerable_pkg), encoding="utf-8")
            scanner = VulnerabilityScanner(str(repo))
            scanner._check_cve_2025_59466()
            self.assertTrue(any(f.get("cve") == "CVE-2025-59466" for f in scanner.findings))

            safe_pkg = {"engines": {"node": ">=22.12.0"}}
            (repo / "package.json").write_text(json.dumps(safe_pkg), encoding="utf-8")
            scanner = VulnerabilityScanner(str(repo))
            scanner._check_cve_2025_59466()
            self.assertFalse(any(f.get("cve") == "CVE-2025-59466" for f in scanner.findings))


if __name__ == "__main__":
    unittest.main()
